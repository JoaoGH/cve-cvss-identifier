import requests
import cvss
import re


def get_cve(code):
    """
    Esta função realiza uma request para buscar a os dados da CVE com base no valor do parâmetro code.

    Args:
        code (string): Código da CVE, por exemplo CVE-2021-34527.

    Returns:
        dict: A resposta de request de busca das infos da CVE.
    """

    base = "https://cve.circl.lu/api/cve/"
    url = base + code
    content = requests.get(url)

    if content.status_code != 200:
        raise Exception("Erro na busca da " + code)

    return content.json()


def calculate_cvss(cve):
    """
    Esta função realiza o calculo da pontuação da vulnerabilidade.

    Args:
        cve (dict): Valor de retornado na busca na função `get_cve(code)`.

    Returns:
        cvss.CVSS2: Um objeto gerado pela biblioteca cvss.
    """

    vector = cve.get("cvss-vector")

    if vector is None:
        return None

    vector = vector.split("/")

    # basescore
    AccessVector = vector[0]
    AccessComplexity = vector[1]
    Authentication = vector[2]
    ConfidentialityImpact = vector[3]
    IntegrityImpact = vector[4]
    AvailabilityImpact = vector[5]

    vector_v2 = ""
    vector_v2 += AccessVector + "/"
    vector_v2 += AccessComplexity + "/"
    vector_v2 += Authentication + "/"
    vector_v2 += ConfidentialityImpact + "/"
    vector_v2 += IntegrityImpact + "/"
    vector_v2 += AvailabilityImpact

    vector_v2 = calcula_pontuacao_temporal(vector_v2)

    vector_v2 = calcula_pontuacao_ambiental(vector_v2)

    c = cvss.CVSS2(vector_v2)

    return c


def calcula_pontuacao_temporal(vector):
    """
    Esta função realiza o calculo da pontuação temporal da vulnerabilidade.

    Args:
        vector (str): String estruturada que será usada no calculo final da CVSS.

    Returns:
        str: String estruturada que será usada no calculo final da CVSS.
    """

    while True:
        calc_temp = input("Calcular scores temporais? \n\tS - Sim \n\tN - Não\n").upper()

        if calc_temp not in ["S", "N"]:
            print("Entrada invalida, tenta novamente com um valor valido.\n")
            continue
        elif calc_temp == "N":
            break

        E = None
        while E not in ["ND", "U", "POC", "F", "H"]:
            print("Informe o nivel de explorabilidade")
            print("\tND  - Not defined")
            print("\tU   - Unproven that expliot exists")
            print("\tPOC - Proof of concept code")
            print("\tF   - Functional exploit exists")
            print("\tH   - High")
            E = input().upper()
        vector += "/E:" + E

        RL = None
        while RL not in ["ND", "OF", "TF", "W", "U"]:
            print("Informe o nivel de remediacao")
            print("\tND  - Not defined")
            print("\tOF  - Official fix")
            print("\tTF  - Temporarary fix")
            print("\tW   - Workaround")
            print("\tU   - Unavailable")
            RL = input().upper()
        vector += "/RL:" + RL

        RC = None
        while RC not in ["ND", "UC", "C", "UR"]:
            print("Informe o nivel de report")
            print("\tND  - Not Defined")
            print("\tUC  - Unconfirmed")
            print("\tC   - Confirmed")
            print("\tUR  - Uncorroborated")
            RC = input().upper()
        vector += "/RC:" + RC

        break

    return vector


def calcula_pontuacao_ambiental(vector):
    """
    Esta função realiza o calculo da pontuação ambiental da vulnerabilidade.

    Args:
        vector (str): String estruturada que será usada no calculo final da CVSS.

    Returns:
        str: String estruturada que será usada no calculo final da CVSS.
    """

    while True:
        calc_env = input("Calcular scores ambientais? \n\tS - Sim \n\tN - Não\n").upper()

        if calc_env not in ["S", "N"]:
            print("Entrada invalida, tenta novamente com um valor valido.\n")
            continue
        elif calc_env == "N":
            break

        CDP = None
        while CDP not in ["ND", "N", "L", "LM", "MH", "H"]:
            print("Informe o nivel de collateral damage potential")
            print("\tND - Not Defined")
            print("\tN  - None")
            print("\tL  - Low-light loss")
            print("\tLM - Low-Medium")
            print("\tMH - Medium-High")
            print("\tH  - High-Catastraphic loss")
            CDP = input().upper()
        vector += "/CDP:" + CDP

        TD = None
        while TD not in ["ND", "L", "M", "H"]:
            print("Informe o nivel de remediação")
            print("\tND - Not Defined")
            print("\tL  - Low")
            print("\tM  - Medium")
            print("\tH  - High")
            TD = input().upper()
        vector += "/TD:" + TD

        CR = None
        while CR not in ["ND", "N", "L", "M", "H"]:
            print("Informe o nivel de confidentiality requirement")
            print("\tND - Not Defined")
            print("\tN  - None")
            print("\tL  - Low")
            print("\tM  - Medium")
            print("\tH  - High")
            CR = input().upper()
        vector += "/CR:" + CR

        IR = None
        while IR not in ["ND", "L", "M", "H"]:
            print("Informe o nivel de Integrity Requirement")
            print("\tND - Not Defined")
            print("\tL  - Low")
            print("\tM  - Medium")
            print("\tH  - High")
            IR = input().upper()
        vector += "/IR:" + IR

        AR = None
        while AR not in ["ND", "L", "M", "H"]:
            print("Informe o nivel de Availability Requirement")
            print("\tND - Not Defined")
            print("\tL  - Low")
            print("\tM  - Medium")
            print("\tH  - High")
            AR = input().upper()
        vector += "/AR:" + AR

        break

    return vector


def show_data(cve, cvssData):
    """
    Esta função realiza a exibição dos dados da CVE e CVSS.

    Args:
        cve (dict): Conteudo geral da vulnerabilidade.
        cvssData (cvss.CVSS2): Objeto contendo o valor calculado da pontuação da vulnerabildiade.

    """

    print("Dados", cve.get("id"))
    print("\tResumo \t\t\t:", cve.get("summary"))
    print("\tPublicado em \t:", cve.get("Published"))
    print("\tModificado em \t:", cve.get("Modified"))
    print()

    if cvssData:
        print("Pontuacao:")
        print("\tBase \t\t\t:", cvssData.base_score)
        print("\tTemporal \t\t:", cvssData.temporal_score)
        print("\tEnvironmental \t:", cvssData.environmental_score)
        print()

    if cve.get("vulnerable_product"):
        print("Produtos Vulneraveis:")
        for it in cve.get("vulnerable_product"):
            print("\t" + it)
        print()

    if cve.get("references"):
        print("Referencias: ")
        for it in cve.get("references"):
            print("\t" + it)


while True:
    code = input("Insira o codigo da CVE: ").upper()

    if not code.startswith("CVE-"):
        code = "CVE-" + code

    if re.match("CVE-[0-9]{4}-[0-9]{4,5}", code):
        break
    else:
        print("Valor invalido.")
        print("Os formatos aceitos são: ")
        print(" - CVE-YYYY-NNNN")
        print(" - YYYY-NNNN")
        print(" - CVE-YYYY-NNNNN")
        print(" - YYYY-NNNNN")
        print("* CVE - prefixo, YYYY - ano, NNNN/NNNNN - código")
        print("")
        print("Tente novamente.")
        print("")

try:
    cve = get_cve(code)

    cvssData = calculate_cvss(cve)

    show_data(cve, cvssData)
except Exception as e:
    print(str(e))
    print("Programa encerrado por segurança.")
